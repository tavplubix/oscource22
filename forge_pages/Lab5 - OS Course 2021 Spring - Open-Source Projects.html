<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Lab5 - OS Course 2021 Spring - Open-Source Projects</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Redmine">
<meta name="keywords" content="issue,bug,tracker">
<meta name="csrf-param" content="authenticity_token">
<meta name="csrf-token" content="dd9yTShMnQKcKFQhRoSF15rGgEa9MXCKNUMtcG4Od6NytJQlHXYGl6wOHrf3viGD690JScrFZkZZ3GbFHQW3ig==">
<link rel="shortcut icon" href="https://forge.ispras.ru/favicon.ico?1642659995">
<link rel="stylesheet" media="all" href="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/jquery-ui-1.css">
<link rel="stylesheet" media="all" href="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/tribute-5.css">
<link rel="stylesheet" media="all" href="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/application.css">
<link rel="stylesheet" media="all" href="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/responsive.css">

<script src="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/jquery-3.js"></script>
<script src="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/jquery-migrate-3.js"></script>
<script src="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/tribute-5.js"></script>
<script src="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/tablesort-5.js"></script>
<script src="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/tablesort-5_002.js"></script>
<script src="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/application.js"></script>
<script src="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/responsive.js"></script>
<script>
//<![CDATA[
$(window).on('load', function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>

<script>
//<![CDATA[
rm = window.rm || {};rm.AutoComplete = rm.AutoComplete || {};rm.AutoComplete.dataSources = '{"issues":"/issues/auto_complete?project_id=oscourse-2021-spring\u0026q=","wiki_pages":"/wiki_pages/auto_complete?project_id=oscourse-2021-spring\u0026q="}';
//]]>
</script>
 <link rel="stylesheet" media="screen" href="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/admin.css">
<!-- page specific tags -->
  <script src="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/attachments.js"></script>

</head>
<body class="project-oscourse-2021-spring has-main-menu controller-wiki action-show avatars-on">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">

        <div class="flyout-menu__search">
            <form action="/projects/oscourse-2021-spring/search" accept-charset="UTF-8" name="form-241feffb" method="get"><input name="utf8" type="hidden" value="✓">
            <input type="hidden" name="wiki_pages" value="1">
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">⚲</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search">
</form>        </div>

        <div class="flyout-menu__avatar ">
                <a href="https://forge.ispras.ru/users/12098"><img alt="" title="Александр Токмаков" class="gravatar" srcset="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/b8899b4ea6afc4650cde974ae3aa70ef.png 2x" src="Lab5%20-%20OS%20Course%202021%20Spring%20-%20Open-Source%20Projects_files/b8899b4ea6afc4650cde974ae3aa70ef_002.png"></a>
            <a class="user active" href="https://forge.ispras.ru/users/12098">avtokmakov</a>
        </div>

        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="my-account" href="https://forge.ispras.ru/my/account">My account</a></li><li><a class="logout" rel="nofollow" data-method="post" href="https://forge.ispras.ru/logout">Sign out</a></li></ul>    </div>
    <div id="loggedas">Logged in as <a class="user active" href="https://forge.ispras.ru/users/12098">avtokmakov</a></div>
    <ul><li><a class="home" href="https://forge.ispras.ru/">Home</a></li><li><a class="my-page" href="https://forge.ispras.ru/my/page">My page</a></li><li><a class="projects" href="https://forge.ispras.ru/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/oscourse-2021-spring/search" accept-charset="UTF-8" name="form-b86c008c" method="get"><input name="utf8" type="hidden" value="✓">
        <input type="hidden" name="scope">
        <input type="hidden" name="wiki_pages" value="1">
        <label for="q">
          <a accesskey="4" href="https://forge.ispras.ru/projects/oscourse-2021-spring/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" data-auto-complete="true">
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">OS Course 2021 Spring</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=wiki" autocomplete="off" data-value-was=""></div><div class="drdn-items projects selection"><strong>Recently used</strong><a title="OS Course 2021 Spring" class="selected" href="https://forge.ispras.ru/projects/oscourse-2021-spring?jump=wiki"><span style="padding-left:0px;">OS Course 2021 Spring</span></a><strong>All Projects</strong><a title="OS Course 2021 Spring" class="selected" href="https://forge.ispras.ru/projects/oscourse-2021-spring?jump=wiki"><span style="padding-left:0px;">OS Course 2021 Spring</span></a></div><div class="drdn-items all-projects selection"><a href="https://forge.ispras.ru/projects?jump=wiki">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">OS Course 2021 Spring</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li>
<a onclick="toggleNewObjectDropdown(); return false;" id="new-object" class="new-object" href="#"> + </a>
<ul class="menu-children"><li><a class="new-version" href="https://forge.ispras.ru/projects/oscourse-2021-spring/versions/new">New version</a></li><li><a class="new-wiki-page" href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/new">New wiki page</a></li><li><a class="new-file" href="https://forge.ispras.ru/projects/oscourse-2021-spring/files/new">New file</a></li></ul>
</li><li><a class="overview" href="https://forge.ispras.ru/projects/oscourse-2021-spring">Overview</a></li><li><a class="activity" href="https://forge.ispras.ru/projects/oscourse-2021-spring/activity">Activity</a></li><li><a class="wiki selected" href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki">Wiki</a></li><li><a class="files" href="https://forge.ispras.ru/projects/oscourse-2021-spring/files">Files</a></li><li><a class="settings" href="https://forge.ispras.ru/projects/oscourse-2021-spring/settings">Settings</a></li></ul>
        <div class="tabs-buttons" style="display: none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          

<h3>Wiki</h3>
<ul>
  <li><a href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki">Start page</a></li>
  <li><a href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/index">Index by title</a></li>
  <li><a href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/date_index">Index by date</a></li>
</ul>




        
    </div>

    <div id="content">
        
        <div class="contextual">

  <a class="icon icon-edit" accesskey="e" href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/Lab5/edit">Edit</a>
  <a class="wiki_page-1037-watcher icon icon-fav-off" data-remote="true" rel="nofollow" data-method="post" href="https://forge.ispras.ru/watchers/watch?object_id=1037&amp;object_type=wiki_page">Watch</a>

  <span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions">Actions</span></span><div class="drdn-content"><div class="drdn-items">
    <a class="icon icon-history" href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/Lab5/history">History</a>

      
      
      
      <a data-confirm="Are you sure?" class="icon icon-del" rel="nofollow" data-method="delete" href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/Lab5">Delete</a>

      <a class="icon icon-add" data-remote="true" href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/new?parent=Lab5">New wiki page</a>
</div></div></span></div>

<p class="breadcrumb"><a href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/Wiki">Wiki</a> » </p>


<div class="wiki wiki-page">
  <a name="Лабораторная-работа-5"></a>
<h1>Лабораторная работа №5<a href="#Лабораторная-работа-5" class="wiki-anchor">¶</a></h1>


	<p>Для получения файлов, необходимых для выполнения работы, следует 
обновить удаленный репозиторий, создать новую ветвь под названием 
working-lab5, после чего выполнить слияние с ней ветви lab5, которая 
появилась в репозитории. О работе с git можно прочитать на <a class="wiki-page" href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/GitManual">соответствующей странице</a>.</p>


	<div class="contextual heading-2" title="Edit this section" id="section-2"><a class="icon-only icon-edit" href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/Lab5/edit?section=2">Edit this section</a></div><a name="Поддержка-HPET"></a>
<h2>Поддержка HPET<a href="#Поддержка-HPET" class="wiki-anchor">¶</a></h2>


	<p>В предыдущей лабораторной работе мы реализовали поддержку 
вытесняющей многозадачности с помощью таймера RTC. Хотя для наших задач 
данный метод даёт приемлемую частоту переключения задач, в настоящее 
время RTC используется исключительно для получения календарного времени.
 Кроме RTC на x86-совместимых системах доступны и другие таймеры, в том 
числе HPET (High Precision Event Timer), который позволяет прозрачно 
заменить функционал таймера RTC. HPET имеет нескольких таймеров, 
доступных для конфигурирования. В репозиторий были добавлены файлы 
timer.c и timer.h. В данных файлах представлена простая абстракция для 
поддержки различных таймеров в JOS. Воспользуйтесь спецификацией HPET 
(доступна в файлах) и реализуйте поддержку для двух таймеров HPET (hpet0
 и hpet1) с периодами генерации прерываний 0.5 и 1.5 секунд 
соответственно. Замените код обработки сигнала EOI в файле trap.c на 
использование функции handle_interrupts из структуры timer_for_schedule.
 Добавьте код обработки прерывания таймера в trap_init аналогично с 
прерыванием часов.</p>


	<p>Для реализации поддержки HPET вам будет необходимо получить доступ к
 таблицам ACPI: RSDP (функция get_rsdp) и HPET (функция get_hpet). 
Алгоритмы получения доступа к таблицам ACPI на различных системах 
описаны в спецификации ACPI. Для упрощения доступа к ним используется 
функция find_acpi_table, которую также требуется реализовать.</p>


	<p>Для настройки прерываний от таймеров HPET реализуйте функции 
hpet_enable_interrupts_timX и hpet_handle_interrupts_timX. Для простоты 
реализации поддержки HPET предлагается использовать режим 
LegacyReplacement, который задействует прерывания на линиях 0 и 8 для 
hpet0 и hpet1 соответственно.</p>


	<p>Выбор таймера производится с помощью функции timers_init в init.c. 
После выполнения задания убедитесь, что операционная система корректно 
работает со всеми таймерами, поддерживающими планировщик задач: hpet0, 
hpet1, rtc.</p>


	<div class="contextual heading-2" title="Edit this section" id="section-3"><a class="icon-only icon-edit" href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/Lab5/edit?section=3">Edit this section</a></div><a name="Синхронизация-между-процессами"></a>
<h2>Синхронизация между процессами<a href="#Синхронизация-между-процессами" class="wiki-anchor">¶</a></h2>


	<p>При параллельной работе нескольких процессов с одной и той же 
областью памяти могут возникать состояния гонки. В случае с JOS, 
например, при выделении памяти процессы могут одновременно обращаться к 
списку свободных страниц, так как все процессы в настоящий момент 
работают в одном адресном пространстве и вышеупомянутый список является 
для них общим. Для предотвращения состояний гонки используется 
синхронизация между процессами, реализуемая с помощью примитивов 
синхронизации, таких как мьютексы, семафоры, блокировки с активным 
ожиданием (спинлоки) и т.д. В данном задании необходимо использовать 
реализованные в JOS спинлоки для синхронизации между процессами при 
выделении и освобождении памяти.</p>


	<p><em>В репозиторий были добавлены файлы alloc.c и spinlock.c. В 
первом находится исходный код аллокатора памяти, которым пользуются 
процессы для выделения и освобождения памяти. Во втором — механизм 
блокировок с активным ожиданием. Необходимо добавить в функции 
test_alloc и test_free (файл alloc.c) защиту блокировками (функции 
spin_lock, spin_unlock) таким образом, чтобы функции выделения и 
освобождения памяти не могли работать со списком страниц одновременно, 
чтобы процессы, которые одновременно их вызывают, не могли повредить 
список свободных страниц памяти.</em></p>


	<p><em>Ошибка повреждения списочной структуры хранения блоков свободной
 памяти проявляет себя нерегулярно. Уменьшив интервал срабатываний 
таймера, можно увеличить вероятность ее возникновения. При возникновении
 ошибки на экран выводится строка вида: kernel panic at kern/alloc.c:20:
 Corrupted list.</em></p>


	<div class="contextual heading-2" title="Edit this section" id="section-4"><a class="icon-only icon-edit" href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/Lab5/edit?section=4">Edit this section</a></div><a name="Time-Stamp-Counter"></a>
<h2>Time Stamp Counter<a href="#Time-Stamp-Counter" class="wiki-anchor">¶</a></h2>


	<p>Следующее упражнение заключается в реализации секундомера. В 
процессорах архитектуры x86 есть 64-битный регистр TSC (Time Stamp 
Counter), в котором находится число тактов процессора с его последнего 
сброса (reset). Инструкция rdtsc копирует значение TSC в регистры 
EDX:EAX (32 страрших бита в каждом из регистров RDX и RAX обнуляются). 
Зная частоту процессора (число тактов в секунду) и количество тактов 
между двумя моментами времени, можно вычислить прошедшее между ними 
время. В настоящий момент на процессорах Intel TSC используется как 
средство высокоточного замера прошедшего времени. На некоторых 
современных процессорах частоту можно извлечь с помощью инструкции CPUID
 из ветвей ART (см. <a href="https://github.com/acidanthera/OpenCorePkg/blob/master/Library/OcCpuLib/FrequencyDetect.c" class="external">функцию InternalCalcluateARTFrequencyIntel</a>), в нашем случае средством подсчёта частоты будет являться другой таймер.</p>


	<p><em>В репозиторий были добавлены файлы tsc.h и tsc.c. В них уже 
реализован подсчет частоты процессора с помощью PIT (Programmable 
Interval Timer) — рекомендуется ознакомиться с этим кодом. Ваша задача 
заключается в реализации функций timer_start, timer_stop и 
timer_cpu_frequency из tsc.c. Функции timer_start и timer_cpu_frequency 
принимают в качестве аргумента название таймера (hpet0, hpet1, pit, pm).
 Если функция timer_stop была вызвана после timer_start, она должна 
выводить на экран время в секундах между этими вызовами. В случае вызова
 timer_stop без предварительного вызова timer_start должна выводиться 
ошибка.</em></p>


	<p><em>Для поддержки остальных таймеров также реализуйте схожим образом
 функции hpet_cpu_frequency и pmtimer_cpu_frequency. Описание таймера 
ACPI PowerManagement можно найти в спецификации ACPI. Обратите внимание,
 что он может быть как 24-битным, так и 32-битным. Пример учёта данной 
особенности можно найти в <a href="https://github.com/acidanthera/OpenCorePkg/blob/master/Library/OcCpuLib/FrequencyDetect.c" class="external">функции InternalCalculateTSCFromPMTimer</a> .</em></p>


	<p><em>Для проверки необходимо добавить команды монитора timer_start, 
timer_stop и timer_freq, которые будут вызывать функции timer_start, 
timer_stop и timer_cpu_frequency соответственно. Чтобы система 
переходила в монитор, нужно отключить старт бесконечно выполняющихся 
программ в kern/init.c.</em></p>


	<p><em>Внимание: код подсчёта частоты процессора с таймером pit может 
некорректно работать в VirtualBox — программа никогда не выходит из 
цикла в функции tsc_calibrate(). В таком случае можно использовать 
другие таймеры.</em></p>


	<p><em>По окончании выполнения работы следует сохранить внесенные изменения и отправить их в удаленный репозиторий.</em></p>
</div>


<fieldset class="collapsible collapsed hide-when-print">
  <legend onclick="toggleFieldset(this);" class="icon icon-collapsed">Files (0)</legend>
  <div style="display: none;">

  

  <div id="wiki_add_attachment">
    <form id="add_attachment_form" enctype="multipart/form-data" action="/projects/oscourse-2021-spring/wiki/Lab5/add_attachment" accept-charset="UTF-8" name="add_attachment_form-8cc33602" method="post"><input name="utf8" type="hidden" value="✓"><input type="hidden" name="authenticity_token" value="dd9yTShMnQKcKFQhRoSF15rGgEa9MXCKNUMtcG4Od6NytJQlHXYGl6wOHrf3viGD690JScrFZkZZ3GbFHQW3ig==">
      <div class="box filedroplistner">
      <p>
<span class="attachments_form">
  <span class="attachments_fields">
  </span>
  <span class="add_attachment" style="">
    <input type="file" name="attachments[dummy][file]" class="file_selector filedrop" multiple="multiple" onchange="addInputFiles(this);" data-max-number-of-files-message="This file cannot be uploaded because it exceeds the maximum number of files that can be attached simultaneously (10)" data-max-file-size="1024000000" data-max-file-size-message="This file cannot be uploaded because it exceeds the maximum allowed file size (977 MB)" data-max-concurrent-uploads="2" data-upload-path="/uploads.js" data-param="attachments" data-description="true" data-description-placeholder="Optional description">
    (Maximum size: 977 MB)
  </span>
</span>

</p>
      </div>
      <input type="submit" name="commit" value="Add" data-disable-with="Add">
</form>  </div>
</div>
</fieldset>

<p class="wiki-update-info">
    Updated by <a class="user active" href="https://forge.ispras.ru/users/2368">Vitaly Cheptsov</a> <a title="03/28/2021 11:00 PM" href="https://forge.ispras.ru/projects/oscourse-2021-spring/activity?from=2021-03-28">11 months</a> ago
    · <a href="https://forge.ispras.ru/projects/oscourse-2021-spring/wiki/Lab5/history">1 revisions</a>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
<div id="footer">
    Powered by <a href="https://www.redmine.org/">Redmine</a> © 2006-2022 Jean-Philippe Lang
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

</div>
</div>







<div role="log" aria-live="assertive" aria-relevant="additions" class="ui-helper-hidden-accessible"></div><div role="log" aria-live="assertive" aria-relevant="additions" class="ui-helper-hidden-accessible"></div><div role="log" aria-live="assertive" aria-relevant="additions" class="ui-helper-hidden-accessible"></div><div role="log" aria-live="assertive" aria-relevant="additions" class="ui-helper-hidden-accessible"></div><div role="log" aria-live="assertive" aria-relevant="additions" class="ui-helper-hidden-accessible"></div><div role="log" aria-live="assertive" aria-relevant="additions" class="ui-helper-hidden-accessible"></div><div role="log" aria-live="assertive" aria-relevant="additions" class="ui-helper-hidden-accessible"></div><div role="log" aria-live="assertive" aria-relevant="additions" class="ui-helper-hidden-accessible"></div></body></html>